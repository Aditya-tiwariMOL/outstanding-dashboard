<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Outstanding Receivables</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --green:#1e8e3e;
  --red:#d93025;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
}

/* ========== PASSCODE ========== */
.lock-screen{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.lock-box{
  background:#fff;
  padding:28px;
  border-radius:14px;
  width:100%;
  max-width:360px;
  text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
}
.lock-box h2{color:var(--brand);margin-bottom:12px}
.lock-box input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
}
.lock-box button{
  width:100%;
  margin-top:12px;
  padding:12px;
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
.error{display:none;color:var(--red);margin-top:8px;font-size:13px}

/* ========== DASHBOARD ========== */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
  display:none;
}

.header{
  text-align:center;
  margin-bottom:20px;
}
.amount{
  font-size:22px;
  font-weight:700;
}
.updated{
  font-size:12px;
  color:#666;
}

.table-wrap{
  background:#fff;
  border-radius:14px;
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px 16px;
  border-top:1px solid var(--border);
  text-align:left;
}

th{
  background:#eef3ff;
  color:var(--brand);
  font-size:0.85rem;
}

.sales{font-weight:700;cursor:pointer}
.customer{padding-left:20px;cursor:pointer}
.invoice{padding-left:36px;font-size:13px;color:#555}

.sales-row{background:#fff}
.customer-row{background:#f6f9ff}
.invoice-row{background:#fafafa}

.total{font-weight:700}
.green{color:var(--green);font-weight:600}
.red{color:var(--red);font-weight:600}

.forecast-input{
  width:110px;
  padding:6px 8px;
  border:1px solid var(--border);
  border-radius:6px;
  text-align:right;
}
.forecast-input:focus{
  outline:none;
  border-color:var(--brand);
}

.edited{background:#fff7db}

/* SUBMIT */
.submit-wrap{
  text-align:center;
  margin:18px 0;
  display:none;
}
.submit-btn{
  background:var(--brand);
  color:#fff;
  padding:12px 28px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
}
.submit-btn:disabled{opacity:.6}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#e6f4ea;
  color:var(--green);
  padding:12px 18px;
  border-radius:8px;
  display:none;
  font-size:14px;
}
</style>
</head>

<body>

<!-- PASSCODE -->
<div class="lock-screen" id="lock">
  <div class="lock-box">
    <h2>Enter Passcode</h2>
    <input type="password" id="pass" placeholder="Passcode">
    <button onclick="checkPass()">Access</button>
    <div class="error" id="err">Wrong passcode</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dash">
  <div class="header">
    <h2>Outstanding Receivables</h2>
    <div class="amount" id="grand"></div>
    <div class="updated" id="updated"></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Sales PIC / Customer</th>
          <th>Forecast</th>
          <th>Total</th>
          <th>On Account</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>

  <div class="submit-wrap" id="submitWrap">
    <button class="submit-btn" id="submitBtn" onclick="submitForecasts()">
      Submit Forecasts
    </button>
  </div>
</div>

<div class="toast" id="toast">✔ Forecasts saved successfully</div>

<script>
/* ===== CONFIG ===== */
const PASS_HASH="158a323a7ba44870f23d96f1516dd70aa48e9a72db4ebb026b0a89e212a208ab";
const API="https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

/* ===== STATE ===== */
let DATA=null, activePIC=null;
let edits={};

/* ===== PASSCODE ===== */
async function checkPass(){
  const h=await sha(pass.value);
  if(h===PASS_HASH){
    lock.style.display="none";
    dash.style.display="block";
    loadData();
  }else{
    err.style.display="block";
  }
}

/* ===== LOAD DATA ===== */
function loadData(){
  fetch(API).then(r=>r.json()).then(d=>{
    DATA=d;
    render();
  });
}

function render(){
  grand.innerText="₹ "+DATA.grandTotal.toLocaleString("en-IN");
  updated.innerText="Last updated: "+
    new Date(DATA.lastUpdated).toLocaleDateString("en-GB",
      {day:"2-digit",month:"short",year:"numeric"});
  drawSales();
}

function drawSales(){
  body.innerHTML="";
  Object.entries(DATA.salesPICs).forEach(([pic,p])=>{
    activePIC=pic;
    row(pic,"sales",p,()=>openSales(pic));
  });
}

function openSales(pic){
  body.innerHTML="";
  activePIC=pic;
  const p=DATA.salesPICs[pic];
  row(pic,"sales",p,drawSales);
  Object.entries(p.customers).forEach(([c,v])=>{
    row(c,"customer",v);
  });
}

function row(label,cls,v,cb){
  const tr=document.createElement("tr");
  tr.className=cls+"-row";

  const name=document.createElement("td");
  name.innerText=label;
  name.className=cls;
  if(cb) name.onclick=cb;
  tr.appendChild(name);

  const ftd=document.createElement("td");
  if(cls==="customer"){
    const input=document.createElement("input");
    input.className="forecast-input";
    input.value=v.forecast||"";
    input.placeholder="₹ Forecast";
    input.oninput=()=>{
      tr.classList.add("edited");
      edits[label]=input.value;
      submitWrap.style.display="block";
    };
    ftd.appendChild(input);
  }else{
    ftd.innerText="–";
  }
  tr.appendChild(ftd);

  tr.appendChild(td(v.total,true));
  tr.appendChild(td(v.onAccount,false,true));
  tr.appendChild(td(v.d90,false,false,true));
  tr.appendChild(td(v.d61_90));
  tr.appendChild(td(v.d31_60));
  tr.appendChild(td(v.d1_30));

  body.appendChild(tr);
}

function td(v,t,g,r){
  const d=document.createElement("td");
  if(!v){d.innerText="–";return d}
  d.innerText="₹"+v.toLocaleString("en-IN");
  if(t)d.classList.add("total");
  if(g)d.classList.add("green");
  if(r)d.classList.add("red");
  return d;
}

/* ===== SUBMIT FORECASTS ===== */
function submitForecasts(){
  submitBtn.disabled=true;
  submitBtn.innerText="Saving...";

  Promise.all(
    Object.entries(edits).map(([customer,forecast])=>{
      return fetch(API,{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:`pic=${encodeURIComponent(activePIC)}&customer=${encodeURIComponent(customer)}&forecast=${forecast}`
      });
    })
  ).then(()=>{
    showToast();
    edits={};
    submitWrap.style.display="none";
    submitBtn.disabled=false;
    submitBtn.innerText="Submit Forecasts";
    document.querySelectorAll(".edited")
      .forEach(r=>r.classList.remove("edited"));
  });
}

/* ===== UTIL ===== */
function showToast(){
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
}

async function sha(t){
  const b=new TextEncoder().encode(t);
  const h=await crypto.subtle.digest("SHA-256",b);
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,"0")).join("");
}
</script>

</body>
</html>
