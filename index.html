<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Outstanding Receivables Dashboard</title>

<style>
:root {
  --brand: #0B419B;
  --light: #f4f7fb;
  --border: #e2e6ef;
}

body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: var(--light);
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 16px;
}

h1 {
  color: var(--brand);
  margin-bottom: 8px;
}

.amount {
  font-size: 34px;
  font-weight: bold;
}

.updated {
  color: #666;
  margin-bottom: 16px;
}

.table-wrap {
  overflow-x: auto;
  background: white;
  border-radius: 12px;
}

table {
  width: 100%;
  min-width: 900px;
  border-collapse: collapse;
}

th {
  background: #eef3ff;
  color: var(--brand);
  padding: 12px;
  text-align: left;
}

td {
  padding: 12px;
  border-top: 1px solid var(--border);
}

.click {
  cursor: pointer;
  font-weight: 600;
}

.sales {
  border-left: 4px solid var(--brand);
}

.customer {
  padding-left: 28px;
  background: #fafcff;
}

.invoice {
  padding-left: 48px;
  font-style: italic;
  color: #444;
}

.red {
  color: #d93025;
  font-weight: 700;
}

/* MOBILE */
@media (max-width: 768px) {
  h1 { font-size: 18px; }
  .amount { font-size: 26px; }
}
</style>
</head>

<body>
<div class="container">
  <h1>Outstanding Receivables Dashboard</h1>
  <div class="amount" id="grandTotal">₹ 0</div>
  <div class="updated" id="updated"></div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let activeSales = null;
let activeCustomer = null;
let DATA = {};

fetch(API_URL)
  .then(r => r.json())
  .then(json => {
    DATA = json.salesPICs;
    document.getElementById("grandTotal").innerText =
      "₹ " + json.grandTotal.toLocaleString("en-IN");
    document.getElementById("updated").innerText =
      "Last updated: " + new Date(json.lastUpdated).toLocaleString();
    renderSales();
  });

function clearBody() {
  document.getElementById("body").innerHTML = "";
}

function renderSales() {
  clearBody();
  activeSales = null;
  activeCustomer = null;

  for (const [sales, s] of Object.entries(DATA)) {
    addRow({
      label: "▶ " + sales,
      cls: "sales click",
      values: s,
      onClick: () => toggleSales(sales)
    });
  }
}

function toggleSales(sales) {
  if (activeSales === sales) {
    renderSales();
    return;
  }

  clearBody();
  activeSales = sales;
  activeCustomer = null;

  const s = DATA[sales];

  addRow({
    label: "▼ " + sales,
    cls: "sales click",
    values: s,
    onClick: () => renderSales()
  });

  for (const [cust, c] of Object.entries(s.customers)) {
    addRow({
      label: "▶ " + cust,
      cls: "customer click",
      values: c,
      onClick: () => toggleCustomer(cust, c)
    });
  }
}

function toggleCustomer(name, cust) {
  clearBody();

  // redraw sales header
  const s = DATA[activeSales];
  addRow({
    label: "▼ " + activeSales,
    cls: "sales click",
    values: s,
    onClick: () => renderSales()
  });

  for (const [custName, c] of Object.entries(s.customers)) {
    if (custName !== name) {
      addRow({
        label: "▶ " + custName,
        cls: "customer click",
        values: c,
        onClick: () => toggleCustomer(custName, c)
      });
    } else {
      addRow({
        label: "▼ " + custName,
        cls: "customer click",
        values: c,
        onClick: () => toggleSales(activeSales)
      });

      c.invoices.forEach(inv => {
        addRow({
          label: inv.invoiceNo,
          cls: "invoice",
          values: inv
        });
      });
    }
  }
}

function addRow({ label, cls, values, onClick }) {
  const tr = document.createElement("tr");
  const td0 = document.createElement("td");
  td0.textContent = label;
  td0.className = cls;
  if (onClick) td0.onclick = onClick;

  tr.appendChild(td0);
  tr.appendChild(td(values.total));
  tr.appendChild(td(values.d90, true));
  tr.appendChild(td(values.d61_90));
  tr.appendChild(td(values.d31_60));
  tr.appendChild(td(values.d1_30));

  document.getElementById("body").appendChild(tr);
}

function td(val, red=false) {
  const td = document.createElement("td");
  td.textContent = val ? val.toLocaleString("en-IN") : "–";
  if (red && val) td.className = "red";
  return td;
}
</script>
</body>
</html>
