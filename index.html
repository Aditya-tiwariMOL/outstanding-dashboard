<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Outstanding Receivables</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --red:#d93025;
  --green:#1e8e3e;
}
body{margin:0;font-family:system-ui;background:var(--bg)}
.container{max-width:1200px;margin:auto;padding:16px}
.header{text-align:center;border-bottom:1px solid var(--border);padding-bottom:12px}
.amount{font-size:22px;font-weight:700}

table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:12px;border-top:1px solid var(--border)}
th{background:#eef3ff;color:var(--brand);font-size:0.85rem}

.sales{font-weight:600;cursor:pointer}
.customer-row{background:#f5f8ff}
.customer{padding-left:18px;cursor:pointer}
.invoice{padding-left:36px;font-size:13px;color:#555}

.forecast-input{
  width:110px;
  padding:6px;
  border:1px solid var(--border);
  border-radius:6px;
}

.green{color:var(--green);font-weight:600}
.red{color:var(--red);font-weight:600}
.total{font-weight:700}

.error-box{
  background:#fff3f3;
  color:#b00020;
  padding:12px;
  border-radius:8px;
  margin:16px 0;
  display:none;
}
</style>
</head>

<body>

<div class="container" id="dash">
  <div class="header">
    <h2>Outstanding Receivables</h2>
    <div class="amount" id="grand">Loading…</div>
    <div id="updated"></div>
  </div>

  <div class="error-box" id="errorBox">
    Unable to load data. Please check Apps Script URL.
  </div>

  <table>
    <thead>
      <tr>
        <th>Sales PIC / Customer</th>
        <th>Forecast</th>
        <th>Total</th>
        <th>On Account</th>
        <th>90+</th>
        <th>61–90</th>
        <th>31–60</th>
        <th>1–30</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let DATA=null, active=null;

fetch(API)
  .then(r=>r.json())
  .then(j=>{
    DATA=j;
    render();
  })
  .catch(()=>{
    errorBox.style.display="block";
    grand.innerText="Error";
  });

function render(){
  grand.innerText="₹ "+DATA.grandTotal.toLocaleString("en-IN");
  updated.innerText="Last updated: "+
    new Date(DATA.lastUpdated).toLocaleDateString("en-GB",
      {day:"2-digit",month:"short",year:"numeric"});
  drawSales();
}

function drawSales(){
  body.innerHTML=""; active=null;
  Object.entries(DATA.salesPICs).forEach(([n,s])=>{
    row(n,"sales",s,()=>openSales(n));
  });
}

function openSales(n){
  body.innerHTML=""; active=n;
  const s=DATA.salesPICs[n];
  row(n,"sales",s,drawSales);
  Object.entries(s.customers).forEach(([c,v])=>{
    row(c,"customer",v);
  });
}

function row(label,cls,v,cb){
  const tr=document.createElement("tr");
  tr.className=cls+"-row";

  const name=document.createElement("td");
  name.innerText=label;
  name.className=cls;
  if(cb) name.onclick=cb;
  tr.appendChild(name);

  const ftd=document.createElement("td");
  if(cls==="customer"){
    const input=document.createElement("input");
    input.className="forecast-input";
    input.value=v.forecast||"";
    input.onblur=()=>saveForecast(active,label,input.value);
    input.onkeydown=e=>{if(e.key==="Enter")input.blur()};
    ftd.appendChild(input);
  }else{
    ftd.innerText="–";
  }
  tr.appendChild(ftd);

  tr.appendChild(td(v.total,true));
  tr.appendChild(td(v.onAccount,false,true));
  tr.appendChild(td(v.d90,false,false,true));
  tr.appendChild(td(v.d61_90));
  tr.appendChild(td(v.d31_60));
  tr.appendChild(td(v.d1_30));

  body.appendChild(tr);
}

function saveForecast(pic,customer,value){
  fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ pic, customer, forecast:value })
  });
}

function td(v,t,g,r){
  const d=document.createElement("td");
  if(!v){d.innerText="–";return d}
  d.innerText="₹"+v;
  if(t)d.classList.add("total");
  if(g)d.classList.add("green");
  if(r)d.classList.add("red");
  return d;
}
</script>

</body>
</html>
