<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Outstanding Receivables Dashboard</title>

<style>
:root {
  --brand: #0B419B;
  --light-bg: #f5f7fb;
  --row-border: #e3e6ee;
}

body {
  font-family: Inter, Arial, sans-serif;
  background: var(--light-bg);
  margin: 0;
  padding: 16px;
}

.container {
  background: #fff;
  padding: 18px 20px 24px;
  border-radius: 8px;
}

/* Header */
.logo {
  font-size: 22px;
  font-weight: 700;
  color: var(--brand);
}

.total {
  font-size: 30px;
  font-weight: 700;
  margin-top: 6px;
}

.updated {
  font-size: 13px;
  color: #666;
  margin-bottom: 16px;
}

/* Scroll container (MOBILE SAFE) */
.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  min-width: 900px;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--row-border);
  text-align: right;
  white-space: nowrap;
}

th:first-child, td:first-child {
  text-align: left;
}

th {
  background: #eef2fb;
  color: var(--brand);
  font-weight: 600;
}

/* Sales PIC */
tr.pic {
  font-weight: 600;
  cursor: pointer;
}

tr.pic td:first-child {
  border-left: 4px solid var(--brand);
}

/* Customer */
tr.customer {
  background: #f9fafc;
  cursor: pointer;
}

tr.customer td:first-child {
  padding-left: 34px;
  font-weight: 500;
}

/* Invoice */
tr.invoice {
  background: #ffffff;
  color: #555;
  font-size: 13px;
}

tr.invoice td:first-child {
  padding-left: 60px;
  font-style: italic;
}

/* Risk highlight */
.risk {
  color: #c0392b;
  font-weight: 700;
}
</style>
</head>

<body>
<div class="container">
  <div class="logo">Outstanding Receivables Dashboard</div>
  <div class="total" id="totalOutstanding">Loading…</div>
  <div class="updated" id="lastUpdated"></div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>90+ Days</th>
          <th>61–90 Days</th>
          <th>31–60 Days</th>
          <th>1–30 Days</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let openPICRow = null;
let openCustomerRow = null;

const fmt = n => n ? Number(n).toLocaleString("en-IN") : "–";

fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    document.getElementById("totalOutstanding").innerText =
      "₹ " + fmt(data.grandTotal);

    document.getElementById("lastUpdated").innerText =
      "Last updated: " + new Date(data.lastUpdated).toLocaleString();

    renderPICs(data.salesPICs);
  });

function renderPICs(pics) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  Object.entries(pics).forEach(([name, pic]) => {
    const row = document.createElement("tr");
    row.className = "pic";
    row.dataset.type = "pic";
    row.dataset.open = "false";

    row.innerHTML = `
      <td>▶ ${name}</td>
      <td>${fmt(pic.total)}</td>
      <td class="risk">${fmt(pic.d90)}</td>
      <td>${fmt(pic.d61_90)}</td>
      <td>${fmt(pic.d31_60)}</td>
      <td>${fmt(pic.d1_30)}</td>
    `;

    row.onclick = () => toggleCustomers(row, pic.customers);
    tbody.appendChild(row);
  });
}

function toggleCustomers(picRow, customers) {
  if (openPICRow && openPICRow !== picRow) {
    removeBelow(openPICRow, "customer");
    openPICRow.dataset.open = "false";
  }

  if (picRow.dataset.open === "true") {
    removeBelow(picRow, "customer");
    picRow.dataset.open = "false";
    openPICRow = null;
    openCustomerRow = null;
    return;
  }

  picRow.dataset.open = "true";
  openPICRow = picRow;
  openCustomerRow = null;

  let ref = picRow;

  Object.entries(customers).forEach(([name, cust]) => {
    const row = document.createElement("tr");
    row.className = "customer";
    row.dataset.type = "customer";
    row.dataset.open = "false";

    row.innerHTML = `
      <td>▶ ${name}</td>
      <td>${fmt(cust.total)}</td>
      <td>${fmt(cust.d90)}</td>
      <td>${fmt(cust.d61_90)}</td>
      <td>${fmt(cust.d31_60)}</td>
      <td>${fmt(cust.d1_30)}</td>
    `;

    row.onclick = e => {
      e.stopPropagation();
      toggleInvoices(row, cust.invoices);
    };

    ref.after(row);
    ref = row;
  });
}

function toggleInvoices(custRow, invoices) {
  if (openCustomerRow && openCustomerRow !== custRow) {
    removeBelow(openCustomerRow, "invoice");
    openCustomerRow.dataset.open = "false";
  }

  if (custRow.dataset.open === "true") {
    removeBelow(custRow, "invoice");
    custRow.dataset.open = "false";
    openCustomerRow = null;
    return;
  }

  custRow.dataset.open = "true";
  openCustomerRow = custRow;

  let ref = custRow;

  invoices.forEach(inv => {
    const row = document.createElement("tr");
    row.className = "invoice";
    row.dataset.type = "invoice";

    row.innerHTML = `
      <td>${inv.invoiceNo}</td>
      <td>${fmt(inv.total)}</td>
      <td>${fmt(inv.d90)}</td>
      <td>${fmt(inv.d61_90)}</td>
      <td>${fmt(inv.d31_60)}</td>
      <td>${fmt(inv.d1_30)}</td>
    `;

    ref.after(row);
    ref = row;
  });
}

function removeBelow(start, type) {
  let n = start.nextSibling;
  while (n && n.dataset.type === type) {
    const r = n;
    n = n.nextSibling;
    r.remove();
  }
}
</script>
</body>
</html>
