<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Outstanding Receivables</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --red:#d93025;
  --green:#1e8e3e;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
}

/* ========== PASSCODE ========== */
.lock-screen{
  min-height:100dvh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:24px;
}

.lock-box{
  background:#fff;
  width:100%;
  max-width:380px;
  padding:30px;
  margin-top:12vh;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  text-align:center;
}

.brand-logo{
  max-width:120px;
  margin-bottom:12px;
}

.brand-name{
  font-size:20px;
  font-weight:800;
  color:var(--brand);
}

.brand-sub{
  font-size:14px;
  color:#555;
  margin-bottom:18px;
}

.lock-box input{
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:1px solid var(--border);
}

.lock-box button{
  width:100%;
  margin-top:12px;
  padding:12px;
  border:none;
  border-radius:8px;
  background:var(--brand);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.error{
  display:none;
  margin-top:10px;
  color:var(--red);
  font-size:13px;
}

/* ========== DASHBOARD ========== */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
  display:none;
}

.header{
  text-align:center;
  padding-bottom:14px;
  margin-bottom:18px;
  border-bottom:1px solid var(--border);
}

.dash-logo{
  max-width:100px;
  margin-bottom:8px;
}

.header h2{
  font-size:1.3rem;
  font-weight:600;
  margin:4px 0 8px;
  color:var(--brand);
}

.amount{
  font-size:22px;
  font-weight:700;
}

#updated{
  font-size:12px;
  color:#666;
}

/* ========== TABLE ========== */
.table-wrap{
  background:#fff;
  border-radius:14px;
  overflow-x:auto;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px 16px;
  border-top:1px solid var(--border);
  text-align:left;
}

th{
  background:#eef3ff;
  color:var(--brand);
  font-size:.85rem;
  font-weight:600;
}

.sales-row{background:#fff}
.customer-row{background:#f5f8ff}
.invoice-row{background:#fafafa}

.sales{font-weight:600;cursor:pointer}
.customer{padding-left:18px;cursor:pointer}
.invoice{padding-left:36px;font-size:13px;color:#555}

.green{color:var(--green);font-weight:600}
.red{color:var(--red);font-weight:600}
.total{font-weight:700}

.forecast-input{
  width:110px;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid var(--border);
}

/* submit bar */
.submit-bar{
  display:none;
  margin-top:12px;
  text-align:right;
}

.submit-btn{
  background:var(--brand);
  color:#fff;
  padding:10px 18px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

/* responsive */
@media(max-width:600px){
  .amount{font-size:20px}
}
</style>
</head>

<body>

<!-- PASSCODE -->
<div class="lock-screen" id="lock">
  <div class="lock-box">
    <img src="https://raw.githubusercontent.com/Aditya-tiwariMOL/outstanding-dashboard/main/MOL%20Logo%2001.png" class="brand-logo">
    <div class="brand-name">MOL Logistics (India) Pvt. Ltd.</div>
    <div class="brand-sub">Outstanding Receivables</div>

    <input type="password" id="pass" placeholder="Enter passcode">
    <button onclick="checkPass()">Access</button>
    <div class="error" id="err">Wrong passcode</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dash">
  <div class="header">
    <img src="https://raw.githubusercontent.com/Aditya-tiwariMOL/outstanding-dashboard/main/MOL%20Logo%2001.png" class="dash-logo">
    <h2>Outstanding Receivables</h2>
    <div class="amount" id="grand"></div>
    <div id="updated"></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Sales PIC / Customer</th>
          <th>Forecast</th>
          <th>Total</th>
          <th>On Account</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>

  <div class="submit-bar" id="submitBar">
    <button class="submit-btn" onclick="submitForecast()">Submit Forecast</button>
  </div>
</div>

<script>
const API_URL = "PASTE_APPS_SCRIPT_URL";
const PASS_HASH = "PASTE_YOUR_SHA256_HASH";

let DATA=null, ready=false, allowed=false;
let activePIC=null;
let forecastBuffer={};

// PREFETCH DATA
fetch(API_URL).then(r=>r.json()).then(d=>{
  DATA=d;
  ready=true;
});

async function checkPass(){
  const h = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pass.value))
    .then(b=>[...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join(""));
  if(h===PASS_HASH){
    allowed=true;
    lock.style.display="none";
    dash.style.display="block";
    if(ready) render();
  }else err.style.display="block";
}

function render(){
  grand.innerText="₹ "+DATA.grandTotal.toLocaleString("en-IN");
  updated.innerText="Last updated: "+new Date(DATA.lastUpdated)
    .toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
  drawSales();
}

function drawSales(){
  body.innerHTML="";
  submitBar.style.display="none";
  Object.entries(DATA.salesPICs).forEach(([n,v])=>{
    addRow(n,"sales",v,()=>openSales(n));
  });
}

function openSales(pic){
  activePIC=pic;
  forecastBuffer={};
  body.innerHTML="";
  submitBar.style.display="none";

  addRow(pic,"sales",DATA.salesPICs[pic],drawSales);

  Object.entries(DATA.salesPICs[pic].customers).forEach(([c,v])=>{
    addRow(c,"customer",v,()=>openCustomer(c));
  });
}

function openCustomer(cust){
  body.innerHTML="";
  submitBar.style.display="block";

  addRow(activePIC,"sales",DATA.salesPICs[activePIC],drawSales);

  Object.entries(DATA.salesPICs[activePIC].customers).forEach(([c,v])=>{
    if(c!==cust) addRow(c,"customer",v,()=>openCustomer(c));
    else{
      addRow(c,"customer",v);
      v.invoices.forEach(i=>addRow(i.invoiceNo,"invoice",i));
    }
  });
}

function addRow(label,type,v,cb){
  const tr=document.createElement("tr");
  tr.className=type+"-row";

  const td0=document.createElement("td");
  td0.innerText=label;
  td0.className=type;
  if(cb) td0.onclick=cb;
  tr.appendChild(td0);

  const ftd=document.createElement("td");
  if(type==="customer"){
    const inp=document.createElement("input");
    inp.className="forecast-input";
    inp.value=v.forecast||"";
    inp.oninput=()=>{
      forecastBuffer[label]=inp.value;
      submitBar.style.display="block";
    };
    ftd.appendChild(inp);
  }else ftd.innerText="–";
  tr.appendChild(ftd);

  tr.appendChild(val(v.total,true));
  tr.appendChild(val(v.onAccount,false,true));
  tr.appendChild(val(v.d90,false,false,true));
  tr.appendChild(val(v.d61_90));
  tr.appendChild(val(v.d31_60));
  tr.appendChild(val(v.d1_30));

  body.appendChild(tr);
}

function submitForecast(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ pic:activePIC, data:forecastBuffer })
  }).then(()=>alert("Forecast saved"));
}

function val(v,t,g,r){
  const td=document.createElement("td");
  if(!v){td.innerText="–";return td}
  td.innerText="₹"+v.toLocaleString("en-IN");
  if(t)td.classList.add("total");
  if(g)td.classList.add("green");
  if(r)td.classList.add("red");
  return td;
}
</script>

</body>
</html>
