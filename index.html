<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Outstanding Receivables Dashboard</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --red:#d93025;
  --green:#1e8e3e;
}

/* Base */
*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:#000;
}

.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}

/* Header */
.header{
  text-align:center;
  margin-bottom:16px;
}

.header h1{
  color:var(--brand);
  margin:0 0 6px;
  font-size:20px;
  font-weight:600;
}

.amount{
  font-size:28px;
  font-weight:700;
}

.updated{
  color:#666;
  font-size:13px;
}

/* Table */
.table-wrap{
  background:#fff;
  border-radius:14px;
  overflow-x:auto;
  box-shadow:0 6px 20px rgba(0,0,0,.04);
}

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:#eef3ff;
  color:var(--brand);
  padding:12px 16px;
  text-align:left;
  font-weight:600;
  white-space:nowrap;
}

td{
  padding:12px 16px;
  border-top:1px solid var(--border);
  vertical-align:top;
  text-align:left;
}

/* Rows */
.sales{
  font-weight:600;
}

.customer{
  font-size:14px;
  font-weight:500;
  max-width:220px;
  white-space:normal;
  word-break:break-word;
  line-height:1.3;
}

.invoice{
  padding-left:24px;
  font-size:13px;
  font-style:italic;
  color:#555;
}

/* Amount styling */
.total{
  font-weight:700;
}

.green{
  color:var(--green);
  font-weight:600;
}

.red{
  color:var(--red);
  font-weight:600;
}

/* Loader */
.loader{
  position:fixed;
  inset:0;
  background:var(--bg);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:600;
  color:var(--brand);
  z-index:9999;
}

/* ===========================
   DESKTOP ONLY IMPROVEMENTS
   =========================== */
@media (min-width:1024px){

  body{font-size:115%}

  th{
    font-size:15px;
    padding:14px 20px;
  }

  td{
    padding:14px 20px;
  }

  .sales{
    font-size:16px;
    font-weight:600;
  }

  .customer{
    font-size:14px;
    font-weight:500;
    max-width:260px;
  }

  .invoice{
    font-size:13px;
  }

  .amount{
    font-size:30px;
  }
}
</style>
</head>

<body>

<div id="loader" class="loader">Loading outstanding data…</div>

<div class="container">
  <div class="header">
    <h1>Outstanding Receivables Dashboard</h1>
    <div class="amount" id="grandTotal">₹ 0</div>
    <div class="updated" id="updated"></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>On Account</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let DATA = {};
let activeSales = null;
let activeCustomer = null;

fetch(API_URL)
  .then(r => r.json())
  .then(init)
  .catch(()=>{
    document.getElementById("loader").textContent="Failed to load data";
  });

function init(json){
  DATA = json.salesPICs;

  document.getElementById("grandTotal").textContent =
    "₹ " + json.grandTotal.toLocaleString("en-IN");

  document.getElementById("updated").textContent =
    "Last updated: " + new Date(json.lastUpdated).toLocaleString();

  renderSales();
  document.getElementById("loader").style.display="none";
}

function clearBody(){
  document.getElementById("body").innerHTML="";
}

function renderSales(){
  clearBody();
  activeSales=null;

  for(const [name,s] of Object.entries(DATA)){
    addRow({
      label:name,
      cls:"sales",
      values:s,
      onClick:()=>openSales(name)
    });
  }
}

function openSales(name){
  clearBody();
  activeSales=name;
  const s=DATA[name];

  addRow({
    label:name,
    cls:"sales",
    values:s,
    onClick:renderSales
  });

  for(const [cust,c] of Object.entries(s.customers)){
    addRow({
      label:cust,
      cls:"customer",
      values:c,
      onClick:()=>openCustomer(cust)
    });
  }
}

function openCustomer(custName){
  clearBody();
  const s=DATA[activeSales];

  addRow({
    label:activeSales,
    cls:"sales",
    values:s,
    onClick:renderSales
  });

  for(const [name,c] of Object.entries(s.customers)){
    if(name!==custName){
      addRow({
        label:name,
        cls:"customer",
        values:c,
        onClick:()=>openCustomer(name)
      });
    }else{
      addRow({
        label:name,
        cls:"customer",
        values:c,
        onClick:()=>openSales(activeSales)
      });

      c.invoices.forEach(inv=>{
        addRow({
          label:inv.invoiceNo,
          cls:"invoice",
          values:inv
        });
      });
    }
  }
}

/* Helpers */
function addRow({label,cls,values,onClick}){
  const tr=document.createElement("tr");

  const td0=document.createElement("td");
  td0.textContent=label;
  td0.className=cls;
  if(onClick) td0.onclick=onClick;
  tr.appendChild(td0);

  tr.appendChild(tdAmt(values.total,true));
  tr.appendChild(tdAmt(values.onAccount,false,true));
  tr.appendChild(tdAmt(values.d90,false,false,true));
  tr.appendChild(tdAmt(values.d61_90));
  tr.appendChild(tdAmt(values.d31_60));
  tr.appendChild(tdAmt(values.d1_30));

  document.getElementById("body").appendChild(tr);
}

function tdAmt(val,isTotal=false,isGreen=false,isRed=false){
  const td=document.createElement("td");
  if(!val){
    td.textContent="–";
    return td;
  }
  td.textContent=formatAmt(val);
  if(isTotal) td.classList.add("total");
  if(isGreen) td.classList.add("green");
  if(isRed) td.classList.add("red");
  return td;
}

function formatAmt(n){
  if(n>=100000) return "₹"+(n/100000).toFixed(1)+"L";
  if(n>=1000) return "₹"+Math.round(n/1000)+"k";
  return "₹"+n;
}
</script>

</body>
</html>
