<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Outstanding Receivables Dashboard</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --red:#d93025;
  --green:#1e8e3e;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:#000;
}

/* ================= PASSCODE SCREEN ================= */
.lock-screen{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.lock-box{
  background:#fff;
  padding:28px;
  border-radius:14px;
  width:100%;
  max-width:320px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  text-align:center;
}

.lock-box h2{
  margin:0 0 16px;
  color:var(--brand);
  font-size:18px;
}

.lock-box input{
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:1px solid var(--border);
  margin-bottom:12px;
}

.lock-box button{
  width:100%;
  padding:12px;
  font-size:15px;
  font-weight:600;
  border:none;
  border-radius:8px;
  background:var(--brand);
  color:#fff;
  cursor:pointer;
}

.lock-box .error{
  color:#d93025;
  font-size:13px;
  margin-top:10px;
  display:none;
}

/* ================= DASHBOARD ================= */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
  display:none;
}

.header{
  text-align:center;
  margin-bottom:16px;
}

.header h1{
  color:var(--brand);
  margin:0 0 6px;
  font-size:20px;
  font-weight:600;
}

.amount{
  font-size:28px;
  font-weight:700;
}

.updated{
  color:#666;
  font-size:13px;
}

/* Table */
.table-wrap{
  background:#fff;
  border-radius:14px;
  overflow-x:auto;
  box-shadow:0 6px 20px rgba(0,0,0,.04);
}

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:#eef3ff;
  color:var(--brand);
  padding:12px 16px;
  text-align:left;
  font-weight:600;
}

td{
  padding:12px 16px;
  border-top:1px solid var(--border);
  vertical-align:top;
  text-align:left;
}

/* Rows */
.sales{ font-weight:600; cursor:pointer; }
.customer{
  font-size:14px;
  font-weight:500;
  max-width:220px;
  white-space:normal;
  word-break:break-word;
  cursor:pointer;
}
.invoice{
  padding-left:24px;
  font-size:13px;
  font-style:italic;
  color:#555;
}

/* Amounts */
.total{ font-weight:700; }
.green{ color:var(--green); font-weight:600; }
.red{ color:var(--red); font-weight:600; }

/* Desktop arrows */
@media (min-width:1024px){
  body{font-size:115%}
  .sales::before{ content:"▸ "; color:#555; }
  .customer::before{ content:"▸ "; color:#888; }
}
</style>
</head>

<body>

<!-- PASSCODE SCREEN -->
<div class="lock-screen" id="lockScreen">
  <div class="lock-box">
    <h2>Enter Passcode</h2>
    <input type="password" id="passInput" placeholder="Passcode" />
    <button onclick="checkPass()">Access Dashboard</button>
    <div class="error" id="errorMsg">No access. Wrong passcode.</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboard">
  <div class="header">
    <h1>Outstanding Receivables Dashboard</h1>
    <div class="amount" id="grandTotal">₹ 0</div>
    <div class="updated" id="updated"></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>On Account</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const PASS_HASH =
"5a5c2e7e7b8c8c4c3b5b47d0c48c1a7e7fbdc6e3b6f1c1bb8e6e4d7b5c7f7e2";

const API_URL =
"https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

/* ================= STATE ================= */
let DATA=null;
let dataReady=false;
let accessGranted=false;
let activeSales=null;

/* ================= FETCH EARLY ================= */
fetch(API_URL)
  .then(r=>r.json())
  .then(json=>{
    DATA=json;
    dataReady=true;
    if(accessGranted) renderDashboard();
  });

/* ================= PASSCODE ================= */
async function checkPass(){
  const input=document.getElementById("passInput").value;
  const hash=await sha256(input);
  if(hash===PASS_HASH){
    accessGranted=true;
    document.getElementById("lockScreen").style.display="none";
    if(dataReady) renderDashboard();
  }else{
    document.getElementById("errorMsg").style.display="block";
  }
}

/* ================= RENDER ================= */
function renderDashboard(){
  document.getElementById("dashboard").style.display="block";
  document.getElementById("grandTotal").textContent =
    "₹ "+DATA.grandTotal.toLocaleString("en-IN");
  document.getElementById("updated").textContent =
    "Last updated: "+new Date(DATA.lastUpdated).toLocaleString();
  renderSales();
}

function clearBody(){ body.innerHTML=""; }

function renderSales(){
  clearBody(); activeSales=null;
  Object.entries(DATA.salesPICs).forEach(([n,s])=>{
    addRow(n,"sales",s,()=>openSales(n));
  });
}

function openSales(name){
  clearBody(); activeSales=name;
  const s=DATA.salesPICs[name];
  addRow(name,"sales",s,renderSales);
  Object.entries(s.customers).forEach(([c,v])=>{
    addRow(c,"customer",v,()=>openCustomer(c));
  });
}

function openCustomer(cust){
  clearBody();
  const s=DATA.salesPICs[activeSales];
  addRow(activeSales,"sales",s,renderSales);
  Object.entries(s.customers).forEach(([c,v])=>{
    if(c!==cust){
      addRow(c,"customer",v,()=>openCustomer(c));
    }else{
      addRow(c,"customer",v,()=>openSales(activeSales));
      v.invoices.forEach(inv=>{
        addRow(inv.invoiceNo,"invoice",inv);
      });
    }
  });
}

function addRow(label,cls,val,click){
  const tr=document.createElement("tr");
  const td0=document.createElement("td");
  td0.textContent=label;
  td0.className=cls;
  if(click) td0.onclick=click;
  tr.appendChild(td0);

  tr.appendChild(tdAmt(val.total,true));
  tr.appendChild(tdAmt(val.onAccount,false,true));
  tr.appendChild(tdAmt(val.d90,false,false,true));
  tr.appendChild(tdAmt(val.d61_90));
  tr.appendChild(tdAmt(val.d31_60));
  tr.appendChild(tdAmt(val.d1_30));

  body.appendChild(tr);
}

function tdAmt(v,isTotal=false,isGreen=false,isRed=false){
  const td=document.createElement("td");
  if(!v){ td.textContent="–"; return td; }
  td.textContent=formatAmt(v);
  if(isTotal) td.classList.add("total");
  if(isGreen) td.classList.add("green");
  if(isRed) td.classList.add("red");
  return td;
}

function formatAmt(n){
  if(n>=100000) return "₹"+(n/100000).toFixed(1)+"L";
  if(n>=1000) return "₹"+Math.round(n/1000)+"k";
  return "₹"+n;
}

/* ================= HASH ================= */
async function sha256(text){
  const data=new TextEncoder().encode(text);
  const hash=await crypto.subtle.digest("SHA-256",data);
  return Array.from(new Uint8Array(hash))
    .map(b=>b.toString(16).padStart(2,"0"))
    .join("");
}
</script>

</body>
</html>
