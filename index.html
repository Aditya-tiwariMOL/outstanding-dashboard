<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Outstanding Receivables Dashboard</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }

    .container {
      background: #fff;
      padding: 20px 24px 30px;
    }

    .logo {
      font-size: 22px;
      font-weight: bold;
    }

    .total {
      font-size: 30px;
      font-weight: bold;
      margin-top: 10px;
    }

    .updated {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      text-align: right;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    tr.clickable {
      cursor: pointer;
    }

    tr.customer {
      background: #fafafa;
    }

    tr.invoice {
      background: #fcfcfc;
    }

    .risk {
      color: #c0392b;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">Outstanding Receivables Dashboard</div>
    <div class="total" id="totalOutstanding">Loading…</div>
    <div class="updated" id="lastUpdated"></div>

    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>90+ Days</th>
          <th>61–90 Days</th>
          <th>31–60 Days</th>
          <th>1–30 Days</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let openPICRow = null;
let openCustomerRow = null;

function fmt(n) {
  return n ? Number(n).toLocaleString("en-IN") : "–";
}

fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    document.getElementById("totalOutstanding").innerText =
      "₹ " + Number(data.grandTotal).toLocaleString("en-IN");

    document.getElementById("lastUpdated").innerText =
      "Last updated: " + new Date(data.lastUpdated).toLocaleString();

    renderPICs(data.salesPICs);
  });

function renderPICs(pics) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  Object.entries(pics).forEach(([picName, pic]) => {
    const picRow = document.createElement("tr");
    picRow.className = "clickable";
    picRow.dataset.type = "pic";
    picRow.dataset.open = "false";

    picRow.innerHTML = `
      <td><b>▶ ${picName}</b></td>
      <td><b>${fmt(pic.total)}</b></td>
      <td class="risk">${fmt(pic.d90)}</td>
      <td>${fmt(pic.d61_90)}</td>
      <td>${fmt(pic.d31_60)}</td>
      <td>${fmt(pic.d1_30)}</td>
    `;

    picRow.onclick = () => toggleCustomers(picRow, pic.customers);
    tbody.appendChild(picRow);
  });
}

function toggleCustomers(picRow, customers) {
  // Close previously open PIC
  if (openPICRow && openPICRow !== picRow) {
    removeBelow(openPICRow, "customer");
    openPICRow.dataset.open = "false";
  }

  // Toggle same PIC
  if (picRow.dataset.open === "true") {
    removeBelow(picRow, "customer");
    picRow.dataset.open = "false";
    openPICRow = null;
    openCustomerRow = null;
    return;
  }

  picRow.dataset.open = "true";
  openPICRow = picRow;
  openCustomerRow = null;

  let ref = picRow;

  Object.entries(customers).forEach(([custName, cust]) => {
    const row = document.createElement("tr");
    row.className = "customer clickable";
    row.dataset.type = "customer";
    row.dataset.open = "false";

    row.innerHTML = `
      <td style="padding-left:30px;">▶ ${custName}</td>
      <td>${fmt(cust.total)}</td>
      <td>${fmt(cust.d90)}</td>
      <td>${fmt(cust.d61_90)}</td>
      <td>${fmt(cust.d31_60)}</td>
      <td>${fmt(cust.d1_30)}</td>
    `;

    row.onclick = (e) => {
      e.stopPropagation();
      toggleInvoices(row, cust.invoices);
    };

    ref.after(row);
    ref = row;
  });
}

function toggleInvoices(custRow, invoices) {
  // Close previously open customer
  if (openCustomerRow && openCustomerRow !== custRow) {
    removeBelow(openCustomerRow, "invoice");
    openCustomerRow.dataset.open = "false";
  }

  // Toggle same customer
  if (custRow.dataset.open === "true") {
    removeBelow(custRow, "invoice");
    custRow.dataset.open = "false";
    openCustomerRow = null;
    return;
  }

  custRow.dataset.open = "true";
  openCustomerRow = custRow;

  let ref = custRow;

  invoices.forEach(inv => {
    const row = document.createElement("tr");
    row.className = "invoice";
    row.dataset.type = "invoice";

    row.innerHTML = `
      <td style="padding-left:60px;">${inv.invoiceNo}</td>
      <td>${fmt(inv.total)}</td>
      <td>${fmt(inv.d90)}</td>
      <td>${fmt(inv.d61_90)}</td>
      <td>${fmt(inv.d31_60)}</td>
      <td>${fmt(inv.d1_30)}</td>
    `;

    ref.after(row);
    ref = row;
  });
}

function removeBelow(startRow, type) {
  let next = startRow.nextSibling;
  while (next && next.dataset.type === type) {
    const remove = next;
    next = next.nextSibling;
    remove.remove();
  }
}
</script>
</body>
</html>
