<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Outstanding Receivables Dashboard</title>

<style>
:root{
  --brand:#0B419B;
  --bg:#f4f7fb;
  --border:#e2e6ef;
  --red:#d93025;
  --green:#188038;
}
body{margin:0;font-family:system-ui;background:var(--bg)}
.container{max-width:1200px;margin:auto;padding:16px}
h1{color:var(--brand)}
.amount{font-size:34px;font-weight:800}
.updated{color:#666;margin-bottom:16px}
.table-wrap{background:#fff;border-radius:14px;overflow-x:auto}
table{width:100%;min-width:900px;border-collapse:collapse}
th{background:#eef3ff;color:var(--brand);padding:12px;text-align:left}
td{padding:12px;border-top:1px solid var(--border)}
.click{cursor:pointer;font-weight:600}
.sales{border-left:4px solid var(--brand)}
.customer{padding-left:28px;background:#fafcff}
.invoice{padding-left:48px;font-style:italic}
.red{color:var(--red);font-weight:700}
.green{color:var(--green);font-weight:700}
.loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700}
</style>
</head>

<body>
<div id="loader" class="loader">Loading…</div>

<div class="container">
<h1>Outstanding Receivables Dashboard</h1>
<div class="amount" id="grandTotal">₹ 0</div>
<div class="updated" id="updated"></div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Sales PIC</th>
  <th>Total</th>
  <th>On Account</th>
  <th>90+</th>
  <th>61–90</th>
  <th>31–60</th>
  <th>1–30</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";
let DATA={},activeSales=null;

fetch(API_URL).then(r=>r.json()).then(j=>{
  DATA=j.salesPICs;
  grandTotal.textContent="₹ "+j.grandTotal.toLocaleString("en-IN");
  updated.textContent="Last updated: "+new Date(j.lastUpdated).toLocaleString();
  renderSales();
  loader.style.display="none";
});

function clear(){body.innerHTML=""}

function renderSales(){
  clear(); activeSales=null;
  for(const [n,s] of Object.entries(DATA)){
    row("▶ "+n,"sales click",s,()=>openSales(n));
  }
}

function openSales(n){
  clear(); activeSales=n;
  const s=DATA[n];
  row("▼ "+n,"sales click",s,renderSales);
  for(const [c,o] of Object.entries(s.customers)){
    row("▶ "+c,"customer click",o,()=>openCustomer(c));
  }
}

function openCustomer(cn){
  clear();
  const s=DATA[activeSales];
  row("▼ "+activeSales,"sales click",s,renderSales);

  for(const [n,c] of Object.entries(s.customers)){
    if(n!==cn){
      row("▶ "+n,"customer click",c,()=>openCustomer(n));
    }else{
      row("▼ "+n,"customer click",c,()=>openSales(activeSales),true);
      c.invoices.forEach(i=>row(i.invoiceNo,"invoice",i));
    }
  }
}

function row(label,cls,v,cb,isCustomer=false){
  const tr=document.createElement("tr");
  const td=document.createElement("td");
  td.textContent=label; td.className=cls;
  if(cb) td.onclick=cb;
  tr.appendChild(td);

  tr.appendChild(tdVal(v.total));
  tr.appendChild(tdVal(isCustomer?v.onAccount:null,"green"));
  tr.appendChild(tdVal(v.d90,"red"));
  tr.appendChild(tdVal(v.d61_90));
  tr.appendChild(tdVal(v.d31_60));
  tr.appendChild(tdVal(v.d1_30));

  body.appendChild(tr);
}

function tdVal(v,c){
  const td=document.createElement("td");
  td.textContent=v?v.toLocaleString("en-IN"):"–";
  if(c&&v) td.className=c;
  return td;
}
</script>
</body>
</html>
