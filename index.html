<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Outstanding Receivables Dashboard</title>

<style>
:root {
  --brand: #0B419B;
  --danger: #c0392b;
  --bg: #f5f7fb;
  --border: #e3e6ee;
}

body {
  margin: 0;
  padding: 14px;
  font-family: Arial, sans-serif;
  background: var(--bg);
}

.container {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
}

/* HEADER */
.logo {
  font-size: 20px;
  font-weight: 700;
  color: var(--brand);
}

.total {
  font-size: 28px;
  font-weight: 700;
  margin-top: 6px;
}

.updated {
  font-size: 13px;
  color: #666;
  margin-bottom: 16px;
}

/* DESKTOP TABLE */
.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  min-width: 900px;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  white-space: nowrap;
}

th:first-child, td:first-child {
  text-align: left;
}

th {
  background: #eef2fb;
  color: var(--brand);
}

/* ROW TYPES */
tr.pic { font-weight: 600; cursor: pointer; }
tr.pic td:first-child { border-left: 4px solid var(--brand); }

tr.customer {
  background: #f9fafc;
  cursor: pointer;
}
tr.customer td:first-child {
  padding-left: 32px;
  font-weight: 500;
}

tr.invoice {
  background: #fff;
  color: #555;
  font-size: 13px;
}
tr.invoice td:first-child {
  padding-left: 56px;
  font-style: italic;
}

.risk { color: var(--danger); font-weight: 700; }

/* MOBILE CARD VIEW */
.mobile-view { display: none; }

.card {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.card h3 {
  margin: 0 0 6px;
  color: var(--brand);
  font-size: 16px;
}

.kv {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 4px 0;
}

.kv strong { color: #000; }

/* RESPONSIVE SWITCH */
@media (max-width: 768px) {
  .table-wrapper { display: none; }
  .mobile-view { display: block; }
}
</style>
</head>

<body>
<div class="container">
  <div class="logo">Outstanding Receivables Dashboard</div>
  <div class="total" id="totalOutstanding">Loading…</div>
  <div class="updated" id="lastUpdated"></div>

  <!-- DESKTOP TABLE -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Sales PIC</th>
          <th>Total</th>
          <th>90+</th>
          <th>61–90</th>
          <th>31–60</th>
          <th>1–30</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- MOBILE CARDS -->
  <div class="mobile-view" id="mobileCards"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let openPICRow = null;
let openCustomerRow = null;

const fmt = n => n ? Number(n).toLocaleString("en-IN") : "–";

fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    document.getElementById("totalOutstanding").innerText =
      "₹ " + fmt(data.grandTotal);

    document.getElementById("lastUpdated").innerText =
      "Last updated: " + new Date(data.lastUpdated).toLocaleString();

    renderDesktop(data.salesPICs);
    renderMobile(data.salesPICs);
  });

/* ---------- DESKTOP ---------- */
function renderDesktop(pics) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  Object.entries(pics).forEach(([picName, pic]) => {
    const picRow = document.createElement("tr");
    picRow.className = "pic";
    picRow.dataset.type = "pic";
    picRow.dataset.open = "false";

    picRow.innerHTML = `
      <td>▶ ${picName}</td>
      <td>${fmt(pic.total)}</td>
      <td class="risk">${fmt(pic.d90)}</td>
      <td>${fmt(pic.d61_90)}</td>
      <td>${fmt(pic.d31_60)}</td>
      <td>${fmt(pic.d1_30)}</td>
    `;

    picRow.onclick = () => toggleCustomers(picRow, pic.customers);
    tbody.appendChild(picRow);
  });
}

function toggleCustomers(picRow, customers) {
  if (openPICRow && openPICRow !== picRow) {
    removeBelow(openPICRow, "customer");
    removeBelow(openPICRow, "invoice");
    openPICRow.dataset.open = "false";
    openCustomerRow = null;
  }

  if (picRow.dataset.open === "true") {
    removeBelow(picRow, "customer");
    removeBelow(picRow, "invoice");
    picRow.dataset.open = "false";
    openPICRow = null;
    openCustomerRow = null;
    return;
  }

  picRow.dataset.open = "true";
  openPICRow = picRow;

  let ref = picRow;
  Object.entries(customers).forEach(([custName, cust]) => {
    const row = document.createElement("tr");
    row.className = "customer";
    row.dataset.type = "customer";
    row.dataset.open = "false";

    row.innerHTML = `
      <td>▶ ${custName}</td>
      <td>${fmt(cust.total)}</td>
      <td>${fmt(cust.d90)}</td>
      <td>${fmt(cust.d61_90)}</td>
      <td>${fmt(cust.d31_60)}</td>
      <td>${fmt(cust.d1_30)}</td>
    `;

    row.onclick = e => {
      e.stopPropagation();
      toggleInvoices(row, cust.invoices);
    };

    ref.after(row);
    ref = row;
  });
}

function toggleInvoices(custRow, invoices) {
  if (openCustomerRow && openCustomerRow !== custRow) {
    removeBelow(openCustomerRow, "invoice");
    openCustomerRow.dataset.open = "false";
  }

  if (custRow.dataset.open === "true") {
    removeBelow(custRow, "invoice");
    custRow.dataset.open = "false";
    openCustomerRow = null;
    return;
  }

  custRow.dataset.open = "true";
  openCustomerRow = custRow;

  let ref = custRow;
  invoices.forEach(inv => {
    const row = document.createElement("tr");
    row.className = "invoice";
    row.dataset.type = "invoice";
    row.innerHTML = `
      <td>${inv.invoiceNo}</td>
      <td>${fmt(inv.total)}</td>
      <td>${fmt(inv.d90)}</td>
      <td>${fmt(inv.d61_90)}</td>
      <td>${fmt(inv.d31_60)}</td>
      <td>${fmt(inv.d1_30)}</td>
    `;
    ref.after(row);
    ref = row;
  });
}

function removeBelow(start, type) {
  let n = start.nextSibling;
  while (n && n.dataset.type === type) {
    const r = n;
    n = n.nextSibling;
    r.remove();
  }
}

/* ---------- MOBILE ---------- */
function renderMobile(pics) {
  const box = document.getElementById("mobileCards");
  box.innerHTML = "";

  Object.entries(pics).forEach(([name, pic]) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${name}</h3>
      <div class="kv"><span>Total</span><strong>₹ ${fmt(pic.total)}</strong></div>
      <div class="kv"><span>90+</span><span class="risk">${fmt(pic.d90)}</span></div>
      <div class="kv"><span>61–90</span><span>${fmt(pic.d61_90)}</span></div>
      <div class="kv"><span>31–60</span><span>${fmt(pic.d31_60)}</span></div>
      <div class="kv"><span>1–30</span><span>${fmt(pic.d1_30)}</span></div>
    `;
    box.appendChild(card);
  });
}
</script>
</body>
</html>
